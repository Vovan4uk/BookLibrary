<ui:composition template="/template/layout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:rich="http://richfaces.org/rich"
                xmlns:a4j="http://richfaces.org/a4j">

    <ui:define name="title">Author details</ui:define>

    <ui:define name="body">
        <h:form id="authorform">
            <f:event type="preRenderView" listener="#{authorAction.loadData}"/>
            <rich:panel header="#{authorAction.currentAuthor.secondName} #{authorAction.currentAuthor.firstName}"
                        id="authorPane">

                <rich:messages globalOnly="true"/><br/>
                <h:inputText value="#{authorAction.currentAuthor.firstName}" id="afirstName">
                    <rich:validator/>
                </h:inputText><br/>
                <h:inputText value="#{authorAction.currentAuthor.secondName}" id="asecondName">
                    <rich:validator/>
                </h:inputText><br/>
                <a4j:commandButton value="Update" action="#{authorAction.update}" render="editPane"
                                   oncomplete="if (#{facesContext.maximumSeverity.ordinal==0
                                   or facesContext.maximumSeverity==null}) {redirectToAuthorList()}">
                    <a4j:param value="#{param['id']}" name="id"/>
                </a4j:commandButton>
                <a4j:commandButton value="Delete" render="editPane"
                                   oncomplete="#{rich:component('confirmPane')}.show()">
                    <a4j:param value="#{param['id']}" name="id"/>
                </a4j:commandButton>
                <a4j:commandButton value="Cancel" oncomplete="redirectToAuthorList()"/>

                <a4j:jsFunction name="redirectToAuthorList" action="authorlist.jsf?faces-redirect=true"/>


                <a4j:jsFunction name="remove" action="#{authorAction.remove}"
                                render="table" execute="@this"
                                oncomplete="if (#{facesContext.maximumSeverity.ordinal==0
                                   or facesContext.maximumSeverity==null}) {redirectToAuthorList()}">
                    <a4j:param value="#{param['id']}" name="id"/>
                </a4j:jsFunction>


                <rich:popupPanel id="confirmPane" autosized="true" header="Confirm delete"
                                 onmaskclick="#{rich:component('confirmPane')}.hide()">
                    <h:outputText value="Are you sure you want to delete #{authorAction.currentAuthor.secondName}
                    #{authorAction.currentAuthor.firstName}"/>
                    <h:outputText value=" with his books: " rendered="#{0 ne authorAction.currentAuthor.books.size()}">
                    </h:outputText>
                    <a4j:repeat value="#{authorAction.currentAuthor.books}" var="book" id="repeat3">
                        <br/><h:outputText value="#{book.name} "/>
                    </a4j:repeat>
                    <h:outputText value="?"/><br/>
                    <a4j:commandButton value="Delete" onclick="remove(); return false;">
                    </a4j:commandButton>
                    <a4j:commandButton value="Cancel" onclick="#{rich:component('confirmPane')}.hide(); return false;"/>
                </rich:popupPanel>


                <br/>
                <h:outputText value="#{authorAction.currentAuthor.averageRating}">
                    <f:convertNumber pattern="0.#"/>
                </h:outputText>
                <br/>

                <h:outputText
                        value="(#{authorAction.currentAuthor.books.size()} books)"/><br/>
                <h:outputText value="#{authorAction.currentAuthor.createDate}"/>
                <br/><br/>

                <rich:dataTable style="width: 100%;">
                    <f:facet name="header">
                        <h:outputText value="Author has not any books yet"
                                      rendered="#{empty authorAction.currentAuthor.books}"/>
                    </f:facet>
                </rich:dataTable>

                <rich:panel
                        header="All books by #{authorAction.currentAuthor.secondName} #{authorAction.currentAuthor.firstName}"
                        rendered="#{not empty authorAction.currentAuthor.books}">
                    <rich:dataTable value="#{authorAction.currentAuthor.books}" var="book" rows="2"
                                    rowClasses="odd-row, even-row" style="width: 100%;">
                        <rich:column styleClass="col_author_book_name" headerClass="col_author_book_name">
                            <f:facet name="header">
                                <h:outputText value="Book name"/>
                            </f:facet>
                            <h:link value="#{book.name}" outcome="/book.xhtml">
                                <f:param name="id" value="#{book.id}"/>
                            </h:link>
                        </rich:column>
                        <rich:column styleClass="col_author_book_isbn" headerClass="col_author_book_isbn">
                            <f:facet name="header">
                                <h:outputText value="Book ISBN"/>
                            </f:facet>
                            <h:outputText value="#{book.isbn}"/>
                        </rich:column>
                        <rich:column styleClass="col_author_book_publisher"
                                     headerClass="col_author_book_publisher">
                            <f:facet name="header">
                                <h:outputText value="Book publisher"/>
                            </f:facet>
                            <h:outputText value="#{book.publisher}"/>
                        </rich:column>
                        <rich:column styleClass="col_author_book_published_date"
                                     headerClass="col_author_book_published_date"
                                     sortBy="#{book.publishedDate}"
                                     sortOrder="#{mainSortingBean.sortsOrders['publishedDate']}">
                            <f:facet name="header">
                                <h:outputText value="Book published date"/>
                            </f:facet>
                            <h:outputText value="#{book.publishedDate}"/>
                        </rich:column>
                        <rich:column styleClass="col_author_book_average_rating"
                                     headerClass="col_author_book_average_rating">
                            <f:facet name="header">
                                <h:outputText value="Book average rating"/>
                            </f:facet>
                            <h:outputText value="#{book.averageRating}">
                                <f:convertNumber pattern="0.#"/>
                            </h:outputText>
                            <h:outputText value="(#{book.reviews.size()})"/>
                        </rich:column>
                        <rich:column styleClass="col_author_book_create_date"
                                     headerClass="col_author_book_create_date">
                            <f:facet name="header">
                                <h:outputText value="Book create date"/>
                            </f:facet>
                            <h:outputText value="#{book.createDate}"/>
                        </rich:column>
                        <f:facet name="footer" id="pagination">
                            <rich:dataScroller renderIfSinglePage="false"/>
                        </f:facet>
                    </rich:dataTable>
                </rich:panel>

            </rich:panel>
        </h:form>
    </ui:define>
</ui:composition>
